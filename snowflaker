#!/usr/bin/env python

import sys
import os
import shutil
import csv

def get_cmd():
    print("\033[1;32mWhat would you like to do? Your options are \"snowflakerize\" or \"undo\"\033[1;0m")
    cmd = raw_input("\033[1;32mType \"s\" for snowflakerize or \"u\" for undo: \033[1;0m").strip()
    return cmd

def get_target_directory():
    dir_name = raw_input("\033[1;32mDrag and drop directory to terminal and press enter: \033[1;0m").strip()
    return dir_name

def snowflakes_exist():
    exists = os.path.isfile('snowflakes.csv')
    return exists

def create_snowflake_map():
    with open('snowflakes.csv', mode='r') as infile:
        reader = csv.reader(infile)
        snowflake_map = dict((rows[0],rows[1]) for rows in reader)
        return snowflake_map

def convert():
    for file in os.listdir("."):
        if file in ['snowflakes.csv']:
            continue
        file_parts = file.split('.')
        filename = file_parts[0]
        ext = file_parts[1]
        if filename in snowflake_map:
            new_name = snowflake_map[filename] + '.' + ext
            print "\033[1;32mSnowflakerizing!\033[1;0m", " %s -----> %s" %(file, new_name)
            os.rename(file, new_name)
        else:
            print "Skipping %s: Not in list of acceptable snowflakes or already snowflakerized" % file

def undo():
    for file in os.listdir("."):
        if file in ['snowflakes.csv']:
            continue
        file_parts = file.split('.')
        filename = file_parts[0]
        ext = file_parts[1]
        if filename in snowflake_map.values():
            for origin in snowflake_map:
                if snowflake_map[origin] == filename:
                    new_name = origin + '.' + ext
                    print "\033[1;32mResetting\033[1;0m", " %s -----> %s" %(file, new_name)
                    os.rename(file, new_name)
        else:
            print "Skipping %s: Not a snowflake" % file

cmd = get_cmd()
if (cmd != 's' and cmd != 'u'):
    print("Did not understand \"%s\"" %cmd)
    sys.exit()

dir_name = get_target_directory()
os.chdir(dir_name)
snowflakes = snowflakes_exist()
if (not snowflakes):
    sys.exit("There doesn't appear to be a snowflakes.csv file in this directory")

snowflake_map = create_snowflake_map()
if cmd == 'u':
    undo()
else:
    convert()

